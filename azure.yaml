# Azure Developer CLI (azd) configuration
# Run 'azd up' to provision infrastructure and deploy the application

name: azure-ai-security-sandbox
metadata:
  template: azure-ai-security-sandbox@0.1.0

# Infrastructure configuration
infra:
  provider: bicep
  path: infra
  module: main

# Services - backend is built and deployed to Container Apps
services:
  backend:
    project: ./app/backend
    language: py
    host: containerapp
    docker:
      remoteBuild: true
  
  # IT Admin Agent API (only deployed when useAgents=true)
  agent:
    project: ./agents/it-admin
    language: py
    host: containerapp
    docker:
      remoteBuild: true

# Hooks for custom deployment logic
hooks:
  # Post-provision: Configure Front Door routes (only if AFD is enabled)
  postprovision:
    shell: sh
    run: |
      if [ -n "$FRONTDOOR_PROFILE_NAME" ] && [ "$FRONTDOOR_PROFILE_NAME" != "" ]; then
        echo "Ensuring Front Door endpoint and route are enabled..."
        az afd endpoint update \
          --resource-group $RESOURCE_GROUP_NAME \
          --profile-name $FRONTDOOR_PROFILE_NAME \
          --name $FRONTDOOR_ENDPOINT_NAME \
          --enabled-state Enabled \
          --output none 2>/dev/null || true

        az afd route update \
          --resource-group $RESOURCE_GROUP_NAME \
          --profile-name $FRONTDOOR_PROFILE_NAME \
          --endpoint-name $FRONTDOOR_ENDPOINT_NAME \
          --name default-route \
          --origin-group containerapp-origin-group \
          --origin-path / \
          --patterns-to-match "/*" \
          --forwarding-protocol HttpsOnly \
          --https-redirect Enabled \
          --supported-protocols Http Https \
          --enabled-state Enabled \
          --output none 2>/dev/null || true
      else
        echo "Front Door is disabled (USE_AFD=false). Skipping AFD configuration."
        echo "App is accessible directly at: $APP_PUBLIC_URL"
      fi
      
      # Run prepdocs from upstream submodule to populate search index
      echo "Running prepdocs to populate search index..."
      
      # Auto-initialize submodule if not present
      if [ ! -f "./upstream/app/backend/prepdocs.py" ]; then
        echo "Initializing upstream submodule..."
        git submodule update --init --recursive
      fi
      
      if [ -d "./upstream" ]; then
        # Set up Python virtual environment if not exists
        if [ ! -d "./.venv" ]; then
          echo "Creating Python virtual environment..."
          python3 -m venv .venv
        fi
        
        # Install prepdocs dependencies
        echo "Installing prepdocs dependencies..."
        ./.venv/bin/pip install -q -r ./upstream/app/backend/requirements.txt
        
        # Set environment variables required by prepdocs
        # Map our Bicep output names to what prepdocs expects
        export OPENAI_HOST="azure"
        export AZURE_OPENAI_EMB_DEPLOYMENT="$AZURE_OPENAI_EMBEDDING_DEPLOYMENT"
        export AZURE_SEARCH_INDEX="documents"
        export AZURE_STORAGE_CONTAINER="documents"
        export AZURE_STORAGE_RESOURCE_GROUP="$RESOURCE_GROUP_NAME"
        export AZURE_OPENAI_EMB_MODEL_NAME="text-embedding-3-small"
        export AZURE_OPENAI_EMB_DIMENSIONS="1536"
        
        # Run prepdocs with upstream data (local strategy, not integrated vectorizer)
        echo "Indexing documents..."
        ./.venv/bin/python ./upstream/app/backend/prepdocs.py './upstream/data/*' --verbose
      else
        echo "Warning: upstream submodule not found. Run 'git submodule update --init'"
      fi

  # Post-down: Purge soft-deleted resources to allow clean redeployment
  postdown:
    shell: sh
    run: |
      echo "Purging soft-deleted resources..."
      
      # Get subscription ID
      SUBSCRIPTION_ID=$(az account show --query id -o tsv)

      # IMPORTANT: Purge ONLY resources associated with this azd environment.
      # Older versions of this hook purged *all* soft-deleted OpenAI/APIM resources
      # in the subscription, which is risky in shared subscriptions.
      EXPECTED_COG_NAME="${AZURE_OPENAI_SERVICE:-}"
      EXPECTED_APIM_NAME="${APIM_SERVICE_NAME:-}"
      if [ -z "$EXPECTED_COG_NAME" ] && [ -z "$EXPECTED_APIM_NAME" ]; then
        echo "No environment-scoped resource names found (AZURE_OPENAI_SERVICE/APIM_SERVICE_NAME not set)."
        echo "Skipping purge to avoid subscription-wide deletion."
        exit 0
      fi
      
      # Purge soft-deleted Cognitive Services (Azure OpenAI)
      echo "Checking for soft-deleted Cognitive Services..."
      DELETED_COG=$(az cognitiveservices account list-deleted --subscription "$SUBSCRIPTION_ID" -o json 2>/dev/null)
      if [ -n "$DELETED_COG" ] && [ "$DELETED_COG" != "[]" ]; then
        if [ -n "$EXPECTED_COG_NAME" ]; then
          MATCHING_COG=$(echo "$DELETED_COG" | jq -r --arg name "$EXPECTED_COG_NAME" '.[] | select(.name == $name) | "\(.name) \(.location)"')
          if [ -n "$MATCHING_COG" ]; then
            echo "$MATCHING_COG" | while read -r NAME LOCATION; do
              if [ -n "$NAME" ]; then
                echo "Purging Cognitive Services: $NAME in $LOCATION"
                az cognitiveservices account purge --name "$NAME" --location "$LOCATION" --subscription "$SUBSCRIPTION_ID" 2>/dev/null || true
              fi
            done
          else
            echo "No soft-deleted Cognitive Services found for: $EXPECTED_COG_NAME"
          fi
        else
          echo "AZURE_OPENAI_SERVICE not set. Skipping Cognitive Services purge."
        fi
      else
        echo "No soft-deleted Cognitive Services found."
      fi
      
      # Purge soft-deleted API Management services
      echo "Checking for soft-deleted API Management services..."
      DELETED_APIM=$(az apim deletedservice list --subscription "$SUBSCRIPTION_ID" -o json 2>/dev/null)
      if [ -n "$DELETED_APIM" ] && [ "$DELETED_APIM" != "[]" ]; then
        if [ -n "$EXPECTED_APIM_NAME" ]; then
          MATCHING_APIM=$(echo "$DELETED_APIM" | jq -r --arg name "$EXPECTED_APIM_NAME" '.[] | select(.name == $name) | "\(.name) \(.location)"')
          if [ -n "$MATCHING_APIM" ]; then
            echo "$MATCHING_APIM" | while read -r NAME LOCATION; do
              if [ -n "$NAME" ]; then
                echo "Purging API Management: $NAME in $LOCATION"
                az apim deletedservice purge --service-name "$NAME" --location "$LOCATION" --subscription "$SUBSCRIPTION_ID" 2>/dev/null || true
              fi
            done
          else
            echo "No soft-deleted API Management services found for: $EXPECTED_APIM_NAME"
          fi
        else
          echo "APIM_SERVICE_NAME not set. Skipping API Management purge."
        fi
      else
        echo "No soft-deleted API Management services found."
      fi
      
      echo "Purge complete."

