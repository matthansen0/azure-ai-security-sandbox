# Azure Developer CLI (azd) configuration
# Run 'azd up' to provision infrastructure and deploy the application

name: azure-ai-security-sandbox
metadata:
  template: azure-ai-security-sandbox@0.1.0

# Infrastructure configuration
infra:
  provider: bicep
  path: infra
  module: main

# No services section needed - Container Apps pulls image directly from MCR
# Functions are deployed via Bicep (consumption plan, code deployed separately if needed)

# Hooks for custom deployment logic
hooks:
  # Post-provision: Configure Front Door routes
  postprovision:
    shell: sh
    run: |
      echo "Ensuring Front Door endpoint and route are enabled..."
      az afd endpoint update \
        --resource-group $RESOURCE_GROUP_NAME \
        --profile-name $FRONTDOOR_PROFILE_NAME \
        --name $FRONTDOOR_ENDPOINT_NAME \
        --enabled-state Enabled \
        --output none 2>/dev/null || true

      az afd route update \
        --resource-group $RESOURCE_GROUP_NAME \
        --profile-name $FRONTDOOR_PROFILE_NAME \
        --endpoint-name $FRONTDOOR_ENDPOINT_NAME \
        --name default-route \
        --origin-group containerapp-origin-group \
        --origin-path / \
        --patterns-to-match "/*" \
        --forwarding-protocol HttpsOnly \
        --https-redirect Enabled \
        --supported-protocols Http Https \
        --enabled-state Enabled \
        --output none 2>/dev/null || true

