# Azure Developer CLI (azd) configuration
# Run 'azd up' to provision infrastructure and deploy the application

name: azure-ai-security-sandbox
metadata:
  template: azure-ai-security-sandbox@0.1.0

# Infrastructure configuration
infra:
  provider: bicep
  path: infra
  module: main

# Services - backend is built and deployed to Container Apps
services:
  backend:
    project: ./app/backend
    language: py
    host: containerapp
    docker:
      remoteBuild: true

# Hooks for custom deployment logic
hooks:
  # Post-provision: Configure Front Door routes (only if AFD is enabled)
  postprovision:
    shell: sh
    run: |
      if [ -n "$FRONTDOOR_PROFILE_NAME" ] && [ "$FRONTDOOR_PROFILE_NAME" != "" ]; then
        echo "Ensuring Front Door endpoint and route are enabled..."
        az afd endpoint update \
          --resource-group $RESOURCE_GROUP_NAME \
          --profile-name $FRONTDOOR_PROFILE_NAME \
          --name $FRONTDOOR_ENDPOINT_NAME \
          --enabled-state Enabled \
          --output none 2>/dev/null || true

        az afd route update \
          --resource-group $RESOURCE_GROUP_NAME \
          --profile-name $FRONTDOOR_PROFILE_NAME \
          --endpoint-name $FRONTDOOR_ENDPOINT_NAME \
          --name default-route \
          --origin-group containerapp-origin-group \
          --origin-path / \
          --patterns-to-match "/*" \
          --forwarding-protocol HttpsOnly \
          --https-redirect Enabled \
          --supported-protocols Http Https \
          --enabled-state Enabled \
          --output none 2>/dev/null || true
      else
        echo "Front Door is disabled (USE_AFD=false). Skipping AFD configuration."
        echo "App is accessible directly at: $APP_PUBLIC_URL"
      fi
      
      # Run prepdocs from upstream submodule to populate search index
      echo "Running prepdocs to populate search index..."
      if [ -d "./upstream" ]; then
        # Set up Python virtual environment if not exists
        if [ ! -d "./.venv" ]; then
          echo "Creating Python virtual environment..."
          python3 -m venv .venv
        fi
        
        # Install prepdocs dependencies
        echo "Installing prepdocs dependencies..."
        ./.venv/bin/pip install -q -r ./upstream/app/backend/requirements.txt
        
        # Run prepdocs with upstream data
        echo "Indexing documents..."
        ./.venv/bin/python ./upstream/app/backend/prepdocs.py './upstream/data/*' --verbose
      else
        echo "Warning: upstream submodule not found. Run 'git submodule update --init'"
      fi

  # Post-down: Purge soft-deleted resources to allow clean redeployment
  postdown:
    shell: sh
    run: |
      echo "Purging soft-deleted resources..."
      
      # Get subscription ID
      SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      
      # Purge soft-deleted Cognitive Services (Azure OpenAI)
      echo "Checking for soft-deleted Cognitive Services..."
      DELETED_COG=$(az cognitiveservices account list-deleted --subscription "$SUBSCRIPTION_ID" -o json 2>/dev/null)
      if [ -n "$DELETED_COG" ] && [ "$DELETED_COG" != "[]" ]; then
        echo "$DELETED_COG" | jq -r '.[] | "\(.name) \(.location)"' | while read -r NAME LOCATION; do
          if [ -n "$NAME" ]; then
            echo "Purging Cognitive Services: $NAME in $LOCATION"
            az cognitiveservices account purge --name "$NAME" --location "$LOCATION" --subscription "$SUBSCRIPTION_ID" 2>/dev/null || true
          fi
        done
      else
        echo "No soft-deleted Cognitive Services found."
      fi
      
      # Purge soft-deleted API Management services
      echo "Checking for soft-deleted API Management services..."
      DELETED_APIM=$(az apim deletedservice list --subscription "$SUBSCRIPTION_ID" -o json 2>/dev/null)
      if [ -n "$DELETED_APIM" ] && [ "$DELETED_APIM" != "[]" ]; then
        echo "$DELETED_APIM" | jq -r '.[] | "\(.name) \(.location)"' | while read -r NAME LOCATION; do
          if [ -n "$NAME" ]; then
            echo "Purging API Management: $NAME in $LOCATION"
            az apim deletedservice purge --service-name "$NAME" --location "$LOCATION" --subscription "$SUBSCRIPTION_ID" 2>/dev/null || true
          fi
        done
      else
        echo "No soft-deleted API Management services found."
      fi
      
      echo "Purge complete."

